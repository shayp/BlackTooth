<!DOCTYPE html>
<html>
<head>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>

    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" />
    <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <script src="/Scripts/handlebars.js"></script>

    <link rel="stylesheet" type="text/css" href="site.css" />
    <title>BlackTooth</title>
    
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <script id="dev-detectedbox" type="text/x-handlebars-template">
        <div id="devDetectedBox_{{mac}}" class="dev-detected" onclick="selectDevice('{{mac}}')">
            <p class="center-aligner">{{name}}</p>
        </div> 
    </script>
    <script id="dev-infocontainerbox" type="text/x-handlebars-template">
        <div id="devInfoContainer_{{mac}}" class="dev-InfoContainer row">
            <p class="center-aligner"><b><u>Device Information</u></b></p><br />
        </div>
    </script>
    <script id="dev-imgbox" type="text/x-handlebars-template">
        <div class="col-md-4">
            <p class="center-aligner"><b><u>Associated Device Image</u></b></p>
            <img src="{{img}}" class="dev-img" />
        </div>
    </script>
    <script id="dev-infobox" type="text/x-handlebars-template">
        <div id="devInfoTable_{{bdaddr}}" class="col-md-4">
            <p class="center-aligner"><b><u>Details:</u></b></p>
            <table id="tblDevInfo_{{bdaddr}}" class="tbl-DevInfo">
                <tr>
                    <td class="dev-info-cell">Device Name</td>
                    <td class="dev-info-cell">{{name}}</td>
                </tr>
                <tr>
                    <td class="dev-info-cell">Vendor</td>
                    <td class="dev-info-cell">{{vendor}}</td>
                </tr>
                <tr>
                    <td class="dev-info-cell">Device Type</td>
                    <td class="dev-info-cell">{{type}}</td>
                </tr>
                <tr>
                    <td class="dev-info-cell">MAC</td>
                    <td class="dev-info-cell">{{bdaddr}}</td>
                </tr>
                <tr>
                    <td class="dev-info-cell">Owner Name</td>
                    <td class="dev-info-cell">{{owner}}</td>
                </tr>
                <tr>
                    <td class="dev-info-cell">Est. Distance</td>
                    <td class="dev-info-cell">{{distance}}</td>
                </tr>
            </table>
        </div>
    </script>
    <div id="masterContainer" class="container">
        <div id="devContentContainer" class="row">
            <div id="devicesView" class="col-md-5">
                <div>
                    <p class="center-aligner">
                        <button id="btnScan">Scan for devices</button><br />
                        <b><u>Detected Devices</u></b>
                    </p>       
                </div>
            </div>
            <div id="deviceOperationsView" class="col-md-2">
                <p class="center-aligner">
                    <b><u>Operations</u></b><br />
                    <button>Save Traffic</button><br />
                    <button>Attempt MITM</button>
                </p>
            </div>
            <div id="map" class="col-md-5"></div>
        </div>
        <div id="devInfoMasterContainer">
            <!-- Old devinfo template
            <div id="devInfoContainer" class="dev-InfoContainer row">
                <p class="center-aligner"><b><u>Device Information</u></b></p><br />
                <div id="devInfo" class="col-md-4">
                    <p class="center-aligner"><b><u>Details:</u></b></p>
                    <table id="tblDevInfo">
                        <tr>
                            <td class="dev-info-cell">Device Name</td>
                            <td class="dev-info-cell">Amir's iPhone 6</td>
                        </tr>
                        <tr>
                            <td class="dev-info-cell">Vendor</td>
                            <td class="dev-info-cell">Apple</td>
                        </tr>
                        <tr>
                            <td class="dev-info-cell">Device Type</td>
                            <td class="dev-info-cell">Phone (Smartphone)</td>
                        </tr>
                        <tr>
                            <td class="dev-info-cell">Bluetooth Version</td>
                            <td class="dev-info-cell">4.2</td>
                        </tr>
                        <tr>
                            <td class="dev-info-cell">MAC</td>
                            <td class="dev-info-cell">DE:AD:BE:EF:0B:AD</td>
                        </tr>
                        <tr>
                            <td class="dev-info-cell">Vendor</td>
                            <td class="dev-info-cell">Apple</td>
                        </tr>
                        <tr>
                            <td class="dev-info-cell">Owner Name</td>
                            <td class="dev-info-cell">Amir</td>
                        </tr>
                    </table>
                </div>
                <div id="devClasses" class="col-md-4">
                    <p class="center-aligner"><b><u>Device Capabilities</u></b></p>
                    <ul>
                        <li>Networking</li>
                        <li>Telephony</li>
                        <li>Object Transfer</li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <p class="center-aligner"><b><u>Associated Device Image</u></b></p>
                    <img src="iphone6plus_gold_portrait.png" class="dev-img" />
                </div>
            </div>
                -->
        </div>
    </div>
    <script>

        var devInfoTableTemplate;
        var devInfoImgTemplate;
        var devInfoContainerTemplate;
        var devDetectedBoxTemplate;

        function selectDevice(mac) {
            if ($("div[data-selectedDev]").length) {
                $("div[data-selectedDev]").stop().animate({ backgroundColor: "rgba(0, 255, 33, 0)" }, "slow");
                $("div[data-selectedDev]").removeAttr("data-selectedDev");

                if ($("div[data-shownInfo]").length) {
                    $("div[data-shownInfo]").stop().fadeOut();
                    $("div[data-shownInfo]").removeAttr("data-shownInfo");
                }
            }

            $("#devDetectedBox_" + mac).attr("data-selectedDev", '');
            $("#devInfoContainer_" + mac).attr("data-shownInfo", '');
            $("#devDetectedBox_" + mac).stop().animate({ backgroundColor: "rgba(0, 255, 33, 1)" }, "slow");
            $("#devInfoContainer_" + mac).stop().fadeIn();
        }

        function addDevice(name, vendor, type, mac, owner, img, capabilities) {
            addDeviceDetectedBox(name, mac);
            addDeviceInfoBox(name, vendor, type, mac, owner, img, capabilities);

            if (0 == $("div[data-selectedDev]").length) {
                selectDevice(mac.replace(/:/g, "_"));
            }
            else {
                $("#devInfoContainer_" + mac.replace(/:/g, "_")).hide();
            }
        }

        function addDeviceDetectedBox(name, mac) {
            var detectedBoxCtx = { name: name, mac: mac.replace(/:/g, "_") };
            var detectedBoxHtml = devDetectedBoxTemplate(detectedBoxCtx);

            $("#devicesView").append(detectedBoxHtml);
        }

        function addDeviceInfoBox(name, vendor, type, mac, owner, img, capabilities) {
            // 1) Create the table div
            var devInfoTableCtx = { name: name, vendor: vendor, type: type, bdaddr: mac, owner: owner, distance: "estimating..." };
            var devInfoTableDivHtml = devInfoTableTemplate(devInfoTableCtx);

            // 2) Create the capabilities div
            var devInfoCapabilitiesHtml = "<div class=\"col-md-4\"><p class=\"center-aligner\"><b><u>Device Capabilities</u></b></p><ul>";

            var i;
            for (i = 0; i < capabilities.length; i++) {
                devInfoCapabilitiesHtml += "<li>" + capabilities[i] + "</li>";
            }

            devInfoCapabilitiesHtml += "</ul></div>";

            // 3) Add the device image div
            var devInfoDevImgCtx = { img: img };
            var devInfoImgDivHtml = devInfoImgTemplate(devInfoDevImgCtx);

            // 4) Make one grand div
            var underscoredMac = mac.replace(/:/g, "_");
            var devInfoContainerCtx = { mac: underscoredMac };

            var devInfoContainerHtml = devInfoContainerTemplate(devInfoContainerCtx);

            $("#devInfoMasterContainer").append(devInfoContainerHtml);
            $("#devInfoContainer_" + underscoredMac).append(devInfoTableDivHtml);
            $("#devInfoContainer_" + underscoredMac).append(devInfoCapabilitiesHtml);
            $("#devInfoContainer_" + underscoredMac).append(devInfoImgDivHtml);
        }

        $(function () {
            devInfoTableTemplate = Handlebars.compile($("#dev-infobox").html());
            devInfoImgTemplate = Handlebars.compile($("#dev-imgbox").html());
            devInfoContainerTemplate = Handlebars.compile($("#dev-infocontainerbox").html());
            devDetectedBoxTemplate = Handlebars.compile($("#dev-detectedbox").html());

            // -- testing infobox addition --
            var capabilities = ["Networking", "Not doing anything", "Telephony"];
            var capabilities2 = ["Networking", "Causing trouble", "Telephony"];

            addDevice("TestPhone", "Testers Inc", "Cellular (Smartphone)", "BA:DB:AD:BA:DB:AD", "Test", "iphone6plus_gold_portrait.png", capabilities);
            addDevice("AnotherPhone", "Nonsense Inc", "Cellular (Smartphone)", "FU:CK:TH:IS:SH:IT", "Dude", "iphone6plus_gold_portrait.png", capabilities2);
        })

    // First, create an object containing LatLng and population for each city.
    var citymap = {
        telaviv:
        {
            center: {lat: 32.078099, lng: 34.779370},
            population: 2714856
        }
    };

    function initMap() {
        var myLatLng = { lat: 32.078099, lng: 34.779370 };

        // Create the map.
        var map = new google.maps.Map(document.getElementById('map'), {
                        zoom: 17,
                        center: myLatLng,
                        mapTypeId: google.maps.MapTypeId.TERRAIN
        });

        var marker = new google.maps.Marker({
                        position: myLatLng,
                        map: map,
                        title: 'Hello World!'
        });

        // Construct the circle for each value in citymap.
        // Note: We scale the area of the circle based on the population.
        for (var city in citymap) {

            // Add the circle for this city to the map.
            var cityCircle = new google.maps.Circle({
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.35,
                map: map,
                center: citymap[city].center,
                radius: 100
            });
        }
    }
    </script>
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAgW2HRWEQJn34UiZV9TEaEtAWQW-m5W3k&callback=initMap">
    </script>
</body>
</html>